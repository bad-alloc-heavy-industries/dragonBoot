<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DFU Request Handler &mdash; dragonBoot  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx_construct.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Windows Platform-Specific Request Handler" href="windows.html" />
    <link rel="prev" title="Request Handlers" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> dragonBoot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../gettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../firmware/index.html">dragonBoot for microcontroller</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">dragonBoot for FPGA</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../platforms/index.html">Platforms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Request Handlers</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">DFU Request Handler</a><ul class="simple">
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="windows.html">Windows Platform-Specific Request Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../luna.html">The LUNA-based USB Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="../flash.html">The SPI Flash controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../descriptors.html">USB Descriptors</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dragonBoot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">dragonBoot for FPGA</a> &raquo;</li>
          <li><a href="index.html">Request Handlers</a> &raquo;</li>
      <li>DFU Request Handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dfu-request-handler">
<h1>DFU Request Handler<a class="headerlink" href="#dfu-request-handler" title="Permalink to this headline"></a></h1>
<div class="toctree-wrapper compound">
</div>
<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFURequestHandler">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.dfu.</span></span><span class="sig-name descname"><span class="pre">DFURequestHandler</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">src_loc_at</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.dfu.DFURequestHandler" title="Permalink to this definition"></a></dt>
<dd><p>The DFU request handling engine</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>interface</strong> – The USB interface number this handler should be bound on - must match value in the descriptors</p></li>
<li><p><strong>resource</strong> – The fully qualified identifier for the platform resource defining the SPI bus to use to access
the configuration Flash</p></li>
</ul>
</dd>
<dt class="field-even">Variables</dt>
<dd class="field-even"><p><strong>triggerReboot</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>output</em>) – A signal indicating if the bootloader should trigger a reboot into the main gateware slot</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>The handler operates by reacting to incomming setup packets for the DFU interface. Of most notable
interest are how it handles DFU detach and download requests as the rest are essentailly boilerplate
requried by the <a class="reference external" href="https://www.usb.org/sites/default/files/DFU_1.1.pdf">DFU 1.1 standard</a>.</p>
<p>Detach requests are handled by asserting the triggerReboot signal and stalling in the HANDLE_DETACH state.
Download requests are handled as follows:</p>
<ul>
<li><p>First we enter the HANDLE_DOWNLOAD state</p></li>
<li><p>The length of the request is checked and if 0, we then enter the HANDLE_DOWNLOAD_COMPLETE state</p>
<blockquote>
<div><ul class="simple">
<li><p>Once in the new state we wait for the status phase where we respond with a ZLP,
and change the DFU state back to dfuIdle</p></li>
<li><p>After completion of the status phase with the resulting acknowledgment returning to us, we enter IDLE again</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If the length of the request is non-zero but less than the Flash sector erase page size, we enter
HANDLE_DOWNLOAD_DATA where the following steps are performed:</p>
<blockquote>
<div><ul class="simple">
<li><p>We first trigger the secondary download state machine which handles pulling the payload bytes
from the stream interface as they come in</p></li>
<li><p>Once the data phase completes, sends the coresponding acknowledgement to let the
host know it was successfull</p></li>
<li><p>As the status phase starts, sends the coresponding ZLP</p></li>
<li><p>Then transitions back to IDLE, resetting the trigger on the download state machine,
when the ACK comes back from the host</p></li>
</ul>
</div></blockquote>
</li>
<li><p>If the length of the request exceeds the Flash device’s sector erase page size, then we send the host
a stall response to indicate failure, and return to IDLE - this should technically be impossible in
a conforming implementation of DFU on the host, but we have to act defensively.</p></li>
</ul>
<p>It is of particular note that the download state machine pushes the payload bytes to the bitstream FIFO
which is also passed through to the SPI Flash interface. This FIFO is created with enough entires
to store a complete Flash sector erase page of data, and re-entry into the HANDLE_DOWNLOAD state is gated
using the DFU protocol’s status system through which we indicate to a host that Flash operations are busy
till not only is the FIFO exhausted, but the SPI Flash engine reports it has completed getting the data
written back to the configuration Flash.</p>
<p>If a DFU implementation tries to send a download request before we tell it we’re ready for another,
it would be considered non-conforming, however this should not hurt us as while it will corrupt
the data written to the Flash, the FIFO can correctly handle exhaustion so should still allow operations
to complete. Therefore we have not attempted to further handle this other than “well just don’t do that then”.</p>
<dl class="py method">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFURequestHandler.elaborate">
<span class="sig-name descname"><span class="pre">elaborate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">platform</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">amaranth.hdl.dsl.Module</span></span></span><a class="headerlink" href="#dragonBoot.dfu.DFURequestHandler.elaborate" title="Permalink to this definition"></a></dt>
<dd><p>Describes the specific gateware needed to implement DFU and its handling on USB EP0</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>platform</strong> – The Amaranth platform for which the gateware will be synthesised</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A complete description of the gateware behaviour required</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.hdl.dsl.Module</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFURequestHandler.handlerCondition">
<span class="sig-name descname"><span class="pre">handlerCondition</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">setup</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">luna.gateware.usb.request.interface.SetupPacket</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.dfu.DFURequestHandler.handlerCondition" title="Permalink to this definition"></a></dt>
<dd><p>Defines the setup packet conditions under which the request handler will operate</p>
<p>This is used to gate the handler’s operation and forms part of the condition under which
the stall-only handler in <code class="xref py py-class docutils literal notranslate"><span class="pre">dragonBoot.bootloader.DragonBoot</span></code> will be triggered</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>setup</strong> – A grouping of signals used to describe the most recent setup packet the control interface has seen</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A combinatorial operation defining the sum conditions under which this handler will operate</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">amranth.hdl.ast.Operator</span></code></p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>The condition for the operation of this handler is defined as being either:</p>
<ul class="simple">
<li><p>A Standard request to the handler’s interface, or</p></li>
<li><p>A Class-specific (ie, DFU) request to the handler’s interface</p></li>
</ul>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFURequestHandler.printSlotInfo">
<span class="sig-name descname"><span class="pre">printSlotInfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">flash</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dragonBoot.platform.Flash</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.dfu.DFURequestHandler.printSlotInfo" title="Permalink to this definition"></a></dt>
<dd><p>Prints out the slot configuration information for the given Flash object</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>flash</strong> – A Flash object containing the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Flash.slots</span></code> and <code class="xref py py-attr docutils literal notranslate"><span class="pre">Flash.partitions</span></code>
information to be printed</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFURequestHandler.generateROM">
<span class="sig-name descname"><span class="pre">generateROM</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">flash</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">dragonBoot.platform.Flash</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">amaranth.hdl.mem.Memory</span></span></span><a class="headerlink" href="#dragonBoot.dfu.DFURequestHandler.generateROM" title="Permalink to this definition"></a></dt>
<dd><p>Generates the ROM for the layout of the Flash</p>
<p>This ROM is laid out as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Address</p></th>
<th class="head"><p>Data</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Slot 0 Begin</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Slot 0 End</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Slot 1 Begin</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Slot 1 End</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p>… |</p></td>
</tr>
</tbody>
</table>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>flash</strong> – The Flash object  from which the ROM image will be derived</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A Memory object defining the Flash slot address layout as described above.
The memory object uses 24-bit entries as the Flash addresses are 24-bit,
and has <code class="xref py py-attr docutils literal notranslate"><span class="pre">Flash.slots</span></code> * 2 entries.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><code class="xref py py-class docutils literal notranslate"><span class="pre">amaranth.hdl.mem.Memory</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUConfig">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.dfu.</span></span><span class="sig-name descname"><span class="pre">DFUConfig</span></span><a class="headerlink" href="#dragonBoot.dfu.DFUConfig" title="Permalink to this definition"></a></dt>
<dd><p>A tracking type for the current state and status of the DFU request handler engine.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>Signal</em><em>(</em><em>4</em><em>, </em><em>decoder = DFUStatus</em><em>)</em>) – A 4-bit register containing the current status of the DFU request handler from the :py:class:DFUStatus enum</p></li>
<li><p><strong>state</strong> (<em>Signal</em><em>(</em><em>4</em><em>, </em><em>decoder = DFUState</em><em>)</em>) – A 4-bit register containing the current state of the DFU request handler from the :py:class:DFUState enum</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.dfu.</span></span><span class="sig-name descname"><span class="pre">DFUState</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.dfu.DFUState" title="Permalink to this definition"></a></dt>
<dd><p>An enumeration of the states the DFU request handler engine can be in.</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState.dfuIdle">
<span class="sig-name descname"><span class="pre">dfuIdle</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">2</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUState.dfuIdle" title="Permalink to this definition"></a></dt>
<dd><p>The DFU request handler is in an idle state</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState.downloadSync">
<span class="sig-name descname"><span class="pre">downloadSync</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">3</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUState.downloadSync" title="Permalink to this definition"></a></dt>
<dd><p>The engine has just finished processing a download request and is awaiting a status request</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState.downloadBusy">
<span class="sig-name descname"><span class="pre">downloadBusy</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">4</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUState.downloadBusy" title="Permalink to this definition"></a></dt>
<dd><p>The engine is processing a download request</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState.downloadIdle">
<span class="sig-name descname"><span class="pre">downloadIdle</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">5</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUState.downloadIdle" title="Permalink to this definition"></a></dt>
<dd><p>The engine has processed at least one download request but is currently idle</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState.uploadIdle">
<span class="sig-name descname"><span class="pre">uploadIdle</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">9</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUState.uploadIdle" title="Permalink to this definition"></a></dt>
<dd><p>The engine has processed at least one upload request but is currently idle</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUState.error">
<span class="sig-name descname"><span class="pre">error</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">10</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUState.error" title="Permalink to this definition"></a></dt>
<dd><p>The engine has encountered an error of some kind</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUStatus">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.dfu.</span></span><span class="sig-name descname"><span class="pre">DFUStatus</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.dfu.DFUStatus" title="Permalink to this definition"></a></dt>
<dd><p>An enumeration of the status states the DFU request handler engine can be in.</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.dfu.DFUStatus.ok">
<span class="sig-name descname"><span class="pre">ok</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">0</span></em><a class="headerlink" href="#dragonBoot.dfu.DFUStatus.ok" title="Permalink to this definition"></a></dt>
<dd><p>The engine is not in error and all is in order</p>
</dd></dl>

</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Request Handlers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="windows.html" class="btn btn-neutral float-right" title="Windows Platform-Specific Request Handler" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2022, Rachel Mant.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>