<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The SPI Flash controller &mdash; dragonBoot  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sphinx_construct.css" type="text/css" />
      <link rel="stylesheet" href="../_static/platformpicker.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/platformpicker.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="USB Descriptors" href="descriptors.html" />
    <link rel="prev" title="The LUNA-based USB Device" href="luna.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> dragonBoot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../gettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../firmware/index.html">dragonBoot for microcontroller</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">dragonBoot for FPGA</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="platforms/index.html">Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="handlers/index.html">Request Handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="luna.html">The LUNA-based USB Device</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">The SPI Flash controller</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="descriptors.html">USB Descriptors</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dragonBoot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">dragonBoot for FPGA</a> &raquo;</li>
      <li>The SPI Flash controller</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-spi-flash-controller">
<h1>The SPI Flash controller<a class="headerlink" href="#the-spi-flash-controller" title="Permalink to this headline"></a></h1>
<div class="toctree-wrapper compound">
</div>
<p>The Flash controller is comprised of two major parts - the underlying
<a class="reference internal" href="#dragonBoot.spi.SPIBus" title="dragonBoot.spi.SPIBus"><code class="xref py py-class docutils literal notranslate"><span class="pre">SPI</span> <span class="pre">bus</span></code></a> engine, and the
<a class="reference internal" href="#dragonBoot.flash.SPIFlash" title="dragonBoot.flash.SPIFlash"><code class="xref py py-class docutils literal notranslate"><span class="pre">Flash</span> <span class="pre">controller</span></code></a> itself.</p>
<span class="target" id="module-dragonBoot.spi"></span><dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.spi.SPIBus">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.spi.</span></span><span class="sig-name descname"><span class="pre">SPIBus</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">src_loc_at</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.spi.SPIBus" title="Permalink to this definition"></a></dt>
<dd><p>SPI bus controller gateware for talking to the Flash.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>cs</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>input</em>) – Chip Select (non-inverted) signal to be passed through to the Flash</p></li>
<li><p><strong>xfer</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>input</em>) – Strobe that signals to start a SPI transfer</p></li>
<li><p><strong>done</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>output</em>) – Strobe that indicates the completion of a SPI transfer</p></li>
<li><p><strong>r_data</strong> (<em>Signal</em><em>(</em><em>8</em><em>)</em><em>, </em><em>output</em>) – Data read from the Flash in the last completed transfer</p></li>
<li><p><strong>w_data</strong> (<em>Signal</em><em>(</em><em>8</em><em>)</em><em>, </em><em>input</em>) – Data to be written to the Flash in the next transfer</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><p><strong>resource</strong> – The fully qualified identifier for the platform resource defining the SPI bus to use</p>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="dragonBoot.spi.SPIBus.elaborate">
<span class="sig-name descname"><span class="pre">elaborate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">platform</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">amaranth.hdl.dsl.Module</span></span></span><a class="headerlink" href="#dragonBoot.spi.SPIBus.elaborate" title="Permalink to this definition"></a></dt>
<dd><p>Describes the specific gateware needed to talk SPI protocol</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>platform</strong> – The Amaranth platform for which the gateware will be synthesised</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A complete description of the gateware behaviour required</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>amaranth.hdl.dsl.Module</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlash">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.flash.</span></span><span class="sig-name descname"><span class="pre">SPIFlash</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">src_loc_at</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.flash.SPIFlash" title="Permalink to this definition"></a></dt>
<dd><p>SPI Flash controller gateware.</p>
<dl class="field-list simple">
<dt class="field-odd">Variables</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>ready</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>output</em>) – Initialisation completion strobe indicating the controller is ready to operate</p></li>
<li><p><strong>start</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>input</em>) – Strobe to instruct the controller to start operations (this is further explained below)</p></li>
<li><p><strong>done</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>output</em>) – Signal that signals the completion of operations pending going to idle</p></li>
<li><p><strong>finish</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>input</em>) – Strobe used to acknowledge completion so the controller can enter idle</p></li>
<li><p><strong>resetAddrs</strong> (<em>Signal</em><em>(</em><em>)</em><em>, </em><em>input</em>) – Strobe used to request the controller reset its internal Flash addressing to the
current values on the beginAddr adn endAddr signals</p></li>
<li><p><strong>beginAddr</strong> (<em>Signal</em><em>(</em><em>24</em><em>)</em><em>, </em><em>input</em>) – The Flash address for the start of an operation. Usually set to the beginning
of a slot when the alt-mode for that slot is selected by the host</p></li>
<li><p><strong>endAddr</strong> (<em>Signal</em><em>(</em><em>24</em><em>)</em><em>, </em><em>input</em>) – The Flash address for the end of an operation. Usually set to the end of a
slot when the alt-mode for that slot is selected by the host</p></li>
<li><p><strong>byteCount</strong> (<em>Signal</em><em>(</em><em>24</em><em>)</em><em>, </em><em>input</em>) – A count of the number of bytes loaded (or being loaded) into the FIFO for the requested
write operation</p></li>
<li><p><strong>readAddr</strong> (<em>Signal</em><em>(</em><em>24</em><em>)</em>) – The internal current read address for the Flash</p></li>
<li><p><strong>eraseAddr</strong> (<em>Signal</em><em>(</em><em>24</em><em>)</em>) – The internal current erase address for the Flash</p></li>
<li><p><strong>writeAddr</strong> (<em>Signal</em><em>(</em><em>24</em><em>)</em>) – The internal current write address for the Flash</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>resource</strong> – The fully qualified identifier for the platform resource defining the SPI bus to use</p></li>
<li><p><strong>fifo</strong> – A FIFO buffer used as the data input to Flash write operations</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>When requested by the start strobe, the controller starts by entering an erase mode which sees
the required Flash pages to write the incomming data from the FIFO erased ready to be written.
On the completion of the required erase operations it then enters into write mode where Flash
page by Flash page the data from the FIFO is read out and written for up to byteCount bytes.</p>
<p>This system is designed with byteCount being equal to a multiple of platform.flash.erasePageSize
right up until the final cycle prior to either a warmboot of the Flash addressing being reset</p>
<dl class="py method">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlash.elaborate">
<span class="sig-name descname"><span class="pre">elaborate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">platform</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">amaranth.hdl.dsl.Module</span></span></span><a class="headerlink" href="#dragonBoot.flash.SPIFlash.elaborate" title="Permalink to this definition"></a></dt>
<dd><p>Describes the specific gateware needed to talk to and erase + rewrite the data in a SPI Flash device</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>platform</strong> – The Amaranth platform for which the gateware will be synthesised</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A complete description of the gateware behaviour required</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>amaranth.hdl.dsl.Module</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashCmd">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.flash.</span></span><span class="sig-name descname"><span class="pre">SPIFlashCmd</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.flash.SPIFlashCmd" title="Permalink to this definition"></a></dt>
<dd><p>An enumeration of the command opcodes for the Flash</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashCmd.pageProgram">
<span class="sig-name descname"><span class="pre">pageProgram</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">2</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashCmd.pageProgram" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashCmd.readStatus">
<span class="sig-name descname"><span class="pre">readStatus</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">5</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashCmd.readStatus" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashCmd.writeEnable">
<span class="sig-name descname"><span class="pre">writeEnable</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">6</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashCmd.writeEnable" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashCmd.releasePowerDown">
<span class="sig-name descname"><span class="pre">releasePowerDown</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">171</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashCmd.releasePowerDown" title="Permalink to this definition"></a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashOp">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">dragonBoot.flash.</span></span><span class="sig-name descname"><span class="pre">SPIFlashOp</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#dragonBoot.flash.SPIFlashOp" title="Permalink to this definition"></a></dt>
<dd><p>An enumeration describing the current overarching operation being completed on the Flash</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashOp.none">
<span class="sig-name descname"><span class="pre">none</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">1</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashOp.none" title="Permalink to this definition"></a></dt>
<dd><p>No action is in progress</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashOp.erase">
<span class="sig-name descname"><span class="pre">erase</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">2</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashOp.erase" title="Permalink to this definition"></a></dt>
<dd><p>A sector erase is in progress</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="dragonBoot.flash.SPIFlashOp.write">
<span class="sig-name descname"><span class="pre">write</span></span><em class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">3</span></em><a class="headerlink" href="#dragonBoot.flash.SPIFlashOp.write" title="Permalink to this definition"></a></dt>
<dd><p>A Flash page write sequence is in progress</p>
</dd></dl>

</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="luna.html" class="btn btn-neutral float-left" title="The LUNA-based USB Device" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="descriptors.html" class="btn btn-neutral float-right" title="USB Descriptors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2022, Rachel Mant.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>